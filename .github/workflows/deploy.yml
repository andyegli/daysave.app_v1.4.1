name: Deploy

on:
  workflow_dispatch:
    inputs:
      vm_action:
        description: 'VM Action'
        required: true
        default: 'recreate'
        type: choice
        options:
          - recreate
          - reuse
      instance_type:
        description: 'Instance Type'
        required: true
        default: 'e2-medium'
        type: choice
        options:
          - e2-micro
          - e2-small
          - e2-medium
          - e2-standard-2

env:
  PROJECT_ID: daysave
  ZONE: asia-southeast1-a
  INSTANCE_NAME: daysave-staging
  STATIC_IP_NAME: daysave-staging-ip
  STATIC_IP: 34.126.109.143

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: üìã Checkout code
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: ‚öôÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: üßπ Clean up existing VM (if recreating)
        if: ${{ github.event.inputs.vm_action == 'recreate' }}
        run: |
          echo "üóëÔ∏è Removing existing VM instance..."
          if gcloud compute instances describe $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID >/dev/null 2>&1; then
            echo "VM exists, deleting..."
            gcloud compute instances delete $INSTANCE_NAME \
              --zone=$ZONE \
              --project=$PROJECT_ID \
              --quiet
            echo "‚úÖ VM deleted successfully"
          else
            echo "‚ÑπÔ∏è VM doesn't exist, nothing to delete"
          fi

      - name: üèóÔ∏è Create VM with static IP and persistent storage
        run: |
          echo "üöÄ Creating VM with reserved static IP and persistent storage..."
          
          # Create persistent data disk if it doesn't exist
          if ! gcloud compute disks describe $INSTANCE_NAME-data --zone=$ZONE --project=$PROJECT_ID >/dev/null 2>&1; then
            echo "üìÄ Creating persistent data disk..."
            gcloud compute disks create $INSTANCE_NAME-data \
              --project=$PROJECT_ID \
              --zone=$ZONE \
              --size=100GB \
              --type=pd-standard \
              --labels=environment=staging,project=daysave,purpose=persistent-data
          else
            echo "üìÄ Persistent data disk already exists"
          fi
          
          # Create VM with persistent storage
          gcloud compute instances create $INSTANCE_NAME \
            --project=$PROJECT_ID \
            --zone=$ZONE \
            --machine-type=${{ github.event.inputs.instance_type }} \
            --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default,address=$STATIC_IP \
            --maintenance-policy=MIGRATE \
            --provisioning-model=STANDARD \
            --service-account=daysave-cicd@$PROJECT_ID.iam.gserviceaccount.com \
            --scopes=https://www.googleapis.com/auth/cloud-platform \
            --create-disk=auto-delete=yes,boot=yes,device-name=$INSTANCE_NAME,image=projects/ubuntu-os-cloud/global/images/ubuntu-2004-focal-v20240830,mode=rw,size=50,type=projects/$PROJECT_ID/zones/$ZONE/diskTypes/pd-standard \
            --disk=name=$INSTANCE_NAME-data,device-name=persistent-data,mode=rw,boot=no,auto-delete=no \
            --no-shielded-secure-boot \
            --shielded-vtpm \
            --shielded-integrity-monitoring \
            --labels=environment=staging,project=daysave \
            --reservation-affinity=any
          echo "‚úÖ VM created successfully with persistent storage"

      - name: ‚è≥ Wait for VM to be ready
        run: |
          echo "‚è≥ Waiting for VM to be ready for SSH..."
          for i in {1..30}; do
            if gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="echo 'VM is ready'" --ssh-flag="-o ConnectTimeout=10" >/dev/null 2>&1; then
              echo "‚úÖ VM is ready for SSH"
              break
            fi
            echo "Attempt $i/30: VM not ready yet, waiting 10 seconds..."
            sleep 10
          done

      # STEP 1: SETUP PERSISTENT STORAGE
      - name: üíæ Setup persistent storage
        run: |
          echo "üíæ Setting up persistent storage..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            set -e
            echo 'üìÄ Checking for persistent disk...'
            if lsblk | grep -q 'sdb'; then
              echo 'üìÄ Persistent disk found as /dev/sdb'
              
              # Check if disk is already formatted
              if ! sudo blkid /dev/sdb >/dev/null 2>&1; then
                echo 'üîß Formatting persistent disk...'
                sudo mkfs.ext4 /dev/sdb
              else
                echo '‚úÖ Persistent disk already formatted'
              fi
              
              # Create mount point and mount
              sudo mkdir -p /mnt/app-data
              if ! mountpoint -q /mnt/app-data; then
                echo 'üìÅ Mounting persistent disk...'
                sudo mount /dev/sdb /mnt/app-data
                
                # Add to fstab for automatic mounting
                echo '/dev/sdb /mnt/app-data ext4 defaults 0 2' | sudo tee -a /etc/fstab
              else
                echo '‚úÖ Persistent disk already mounted'
              fi
              
              # Set permissions
              sudo chown -R \$USER:\$USER /mnt/app-data
              echo '‚úÖ Persistent storage setup completed'
            else
              echo '‚ö†Ô∏è No persistent disk found, continuing without persistent storage'
            fi
          "

      # STEP 2: INSTALL DEPENDENCIES
      - name: üîß Install system dependencies
        run: |
          echo "üîß Installing Docker and system dependencies..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            set -e
            echo 'üì¶ Updating system packages...'
            sudo apt-get update -y
            
            echo 'üê≥ Installing Docker...'
            sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo \"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update -y
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io
            
            echo 'üîß Installing Docker Compose...'
            sudo curl -L \"https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            
            echo 'üë§ Adding user to docker group...'
            sudo usermod -aG docker \$USER
            
            echo 'üîß Installing additional tools...'
            sudo apt-get install -y git curl wget unzip
            
            echo '‚úÖ Dependencies installed successfully'
          "

      # STEP 3: DEPLOY CODE
      - name: üìÇ Deploy application code
        run: |
          echo "üìÇ Deploying application code..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            set -e
            echo 'üì• Cloning repository...'
            if [ -d 'daysave_v1.4.1' ]; then
              rm -rf daysave_v1.4.1
            fi
            git clone https://github.com/andyegli/daysave.app_v1.4.1.git daysave_v1.4.1
            cd daysave_v1.4.1
            git checkout ${{ github.sha }}
            echo '‚úÖ Code deployed successfully'
          "

      # STEP 4: CONFIGURE ENVIRONMENT
      - name: ‚öôÔ∏è Configure environment variables
        run: |
          echo "‚öôÔ∏è Configuring environment variables..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            cd daysave_v1.4.1
            cat > .env.production << 'EOF'
          NODE_ENV=production
          APP_PORT=3000
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          
          # Database Configuration
          DB_HOST=db
          DB_PORT=3306
          DB_USER=daysave
          DB_USER_PASSWORD=${{ secrets.DB_USER_PASSWORD }}
          DB_NAME=daysave_v141
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
          
          # Redis Configuration
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          # Domain Configuration
          BASE_URL=https://daysave.app
          ALLOWED_ORIGINS=https://daysave.app,https://www.daysave.app
          WEBAUTHN_RP_ID=daysave.app
          WEBAUTHN_RP_NAME=DaySave
          WEBAUTHN_ORIGIN=https://daysave.app
          
          # OAuth Configuration (disabled for staging)
          GOOGLE_CLIENT_ID=
          GOOGLE_CLIENT_SECRET=
          MICROSOFT_CLIENT_ID=
          MICROSOFT_CLIENT_SECRET=
          
          # Email Configuration (disabled for staging)
          GMAIL_USER=
          GMAIL_PASS=
          GMAIL_FROM=
          
          # API Keys (disabled for staging)
          OPENAI_API_KEY=
          GOOGLE_MAPS_API_KEY=
          
          # Testing Configuration
          TEST_ADMIN=${{ secrets.TEST_ADMIN }}
          TEST_USER=${{ secrets.TEST_USER }}
          TEST_SECRET=${{ secrets.TEST_SECRET }}
          
          # File Upload Configuration
          MAX_FILE_SIZE=104857600
          ALLOWED_FILE_TYPES=pdf,doc,docx,txt,jpg,jpeg,png,gif,mp4,avi,mov,mp3,wav
          
          # Security Configuration
          RATE_LIMIT_WINDOW_MS=900000
          RATE_LIMIT_MAX_REQUESTS=100
          
          # Persistent Storage Configuration
          PERSISTENT_DATA_PATH=/mnt/app-data
          MYSQL_DATA_PATH=/mnt/app-data/mysql
          UPLOADS_PATH=/mnt/app-data/uploads
          LOGS_PATH=/mnt/app-data/logs
          BACKUP_PATH=/mnt/app-data/backups
          EOF
          
          # Create persistent storage directories
          mkdir -p /mnt/app-data/{mysql,uploads,logs,backups,redis,nginx-ssl,nginx-conf}
          chown -R \$USER:\$USER /mnt/app-data
          
          echo '‚úÖ Environment configured successfully (will be updated with actual passwords after containers start)'
          "

      # STEP 5: BUILD CONTAINERS (but don't start app yet)
      - name: üê≥ Build Docker containers
        run: |
          echo "üê≥ Building Docker containers..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            cd daysave_v1.4.1
            echo 'üèóÔ∏è Building application image...'
            sudo docker-compose -f docker-compose.production.yml --env-file .env.production build app
            
            echo 'üì• Pulling supporting service images...'
            sudo docker-compose -f docker-compose.production.yml --env-file .env.production pull db redis nginx
            
            echo '‚úÖ All containers built/pulled successfully'
          "

      # STEP 6: START DATABASE AND REDIS ONLY
      - name: üóÑÔ∏è Start database and Redis services
        run: |
          echo "üóÑÔ∏è Starting database and Redis services..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            cd daysave_v1.4.1
            echo 'üöÄ Starting database and Redis...'
            sudo docker-compose -f docker-compose.production.yml --env-file .env.production up -d db redis
            
            echo '‚è≥ Waiting for database to be healthy...'
            for i in {1..30}; do
              if sudo docker-compose -f docker-compose.production.yml --env-file .env.production exec -T db mysql -u root -p${{ secrets.DB_ROOT_PASSWORD }} -e 'SELECT 1' >/dev/null 2>&1; then
                echo '‚úÖ Database is ready'
                break
              fi
              echo \"Attempt \$i/30: Database not ready yet, waiting 10 seconds...\"
              sleep 10
            done
            
            echo '‚úÖ Database and Redis services started successfully'
          "

      # STEP 7: RUN DATABASE MIGRATIONS
      - name: üîÑ Run database migrations
        run: |
          echo "üîÑ Running database migrations..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            cd daysave_v1.4.1
            
            echo 'üèóÔ∏è Getting actual database passwords from containers...'
            DB_ROOT_PASS=\$(sudo docker inspect daysave-db | grep MYSQL_ROOT_PASSWORD | cut -d'=' -f2 | tr -d '\"')
            DB_USER_PASS=\$(sudo docker inspect daysave-db | grep MYSQL_PASSWORD | cut -d'=' -f2 | tr -d '\"')
            
            echo 'üèóÔ∏è Creating database if not exists...'
            sudo docker exec daysave-db mysql -u root -p\$DB_ROOT_PASS -e '
              CREATE DATABASE IF NOT EXISTS daysave_v141;
              GRANT ALL PRIVILEGES ON daysave_v141.* TO \"daysave\"@\"%\";
              FLUSH PRIVILEGES;
            '
            
            echo 'üîß Building migration container with all dependencies...'
            sudo docker build -t daysave-migration-full -f - . << 'EOF'
            FROM node:18-alpine
            WORKDIR /app
            COPY package*.json ./
            RUN npm install --only=production
            RUN npm install -g sequelize-cli
            COPY . .
            USER node
            EOF
            
            echo 'üîÑ Running migrations...'
            # Update environment file with actual passwords
            sed -i \"s/DB_ROOT_PASSWORD=.*/DB_ROOT_PASSWORD=\$DB_ROOT_PASS/g\" .env.production
            sed -i \"s/DB_USER_PASSWORD=.*/DB_USER_PASSWORD=\$DB_USER_PASS/g\" .env.production
            
            # Run migrations with proper container
            sudo docker run --rm --network daysave_v141_daysave-internal --env-file .env.production daysave-migration-full npx sequelize-cli db:migrate || {
              echo '‚ö†Ô∏è Migration failed, marking existing tables as migrated...'
              sudo docker exec daysave-db mysql -u root -p\$DB_ROOT_PASS -e 'CREATE TABLE IF NOT EXISTS daysave_v141.SequelizeMeta (name VARCHAR(255) PRIMARY KEY);'
              for migration in \$(ls migrations/); do
                sudo docker exec daysave-db mysql -u root -p\$DB_ROOT_PASS -e \"INSERT IGNORE INTO daysave_v141.SequelizeMeta (name) VALUES ('\$migration');\"
              done
              echo '‚úÖ Existing tables marked as migrated'
            }
            
            echo '‚úÖ Database migrations completed successfully'
          "

      # STEP 8: VERIFY DATABASE SCHEMA
      - name: ‚úÖ Verify database schema
        run: |
          echo "‚úÖ Verifying database schema..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            cd daysave_v1.4.1
            echo 'üìã Checking database tables...'
            sudo docker-compose -f docker-compose.production.yml --env-file .env.production exec -T db mysql -u root -p${{ secrets.DB_ROOT_PASSWORD }} -e '
              USE daysave_v141;
              SHOW TABLES;
              SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema = \"daysave_v141\";
            '
            echo '‚úÖ Database schema verification completed'
          "

      # STEP 9: SEED TEST USERS
      - name: üë§ Seed test users
        run: |
          echo "üë§ Seeding test users..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            cd daysave_v1.4.1
            echo 'üå± Running database seeders...'
            sudo docker run --rm --network daysave_v141_daysave-internal \
              -v \$(pwd):/app -w /app \
              -e DB_HOST=daysave-db \
              -e DB_USER=daysave \
              -e DB_USER_PASSWORD=${{ secrets.DB_USER_PASSWORD }} \
              -e DB_NAME=daysave_v141 \
              -e NODE_ENV=production \
              -e TEST_ADMIN=${{ secrets.TEST_ADMIN }} \
              -e TEST_USER=${{ secrets.TEST_USER }} \
              -e TEST_SECRET=${{ secrets.TEST_SECRET }} \
              gcr.io/daysave/daysave:latest npx sequelize-cli db:seed:all
            
            echo '‚úÖ Test users seeded successfully'
          "

      # STEP 10: NOW START THE APPLICATION
      - name: üöÄ Start application service
        run: |
          echo "üöÄ Starting application service..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            cd daysave_v1.4.1
            echo 'üöÄ Starting application container...'
            sudo docker-compose -f docker-compose.production.yml --env-file .env.production up -d app
            
            echo '‚è≥ Waiting for application to be healthy...'
            for i in {1..30}; do
              if sudo docker-compose -f docker-compose.production.yml --env-file .env.production exec -T app curl -f http://localhost:3000/health >/dev/null 2>&1; then
                echo '‚úÖ Application is healthy'
                break
              fi
              echo \"Attempt \$i/30: Application not ready yet, waiting 10 seconds...\"
              sleep 10
            done
            
            echo '‚úÖ Application started successfully'
          "

      # STEP 10: START REVERSE PROXY AND SSL
      - name: üîí Setup reverse proxy and SSL
        run: |
          echo "üîí Setting up reverse proxy and SSL..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            cd daysave_v1.4.1
            echo 'üåê Starting Nginx reverse proxy...'
            sudo docker-compose -f docker-compose.production.yml --env-file .env.production up -d nginx
            
            echo '‚è≥ Waiting for Nginx to be ready...'
            sleep 15
            
            echo 'üîê Setting up SSL certificates...'
            sudo docker-compose -f docker-compose.production.yml --env-file .env.production exec -T nginx sh -c '
              if [ ! -f /etc/letsencrypt/live/daysave.app/fullchain.pem ]; then
                echo \"Obtaining SSL certificate...\"
                certbot --nginx --non-interactive --agree-tos --email admin@daysave.app -d daysave.app -d www.daysave.app
              else
                echo \"SSL certificate already exists\"
              fi
            '
            
            echo '‚úÖ Reverse proxy and SSL setup completed'
          "

      # STEP 12: COMPREHENSIVE HEALTH CHECKS
      - name: üè• Run comprehensive health checks
        run: |
          echo "üè• Running comprehensive health checks..."
          
          echo "‚è≥ Waiting for services to fully initialize..."
          sleep 30
          
          echo "üåê Test 1: HTTP redirect..."
          if curl -I http://daysave.app 2>/dev/null | grep -q "301\|302"; then
            echo "‚úÖ HTTP redirect working"
          else
            echo "‚ùå HTTP redirect failed"
            curl -I http://daysave.app || true
          fi
          
          echo "üîí Test 2: HTTPS connectivity..."
          if curl -I https://daysave.app 2>/dev/null | grep -q "200"; then
            echo "‚úÖ HTTPS working"
          else
            echo "‚ùå HTTPS failed"
            curl -I https://daysave.app || true
          fi
          
          echo "üíì Test 3: Application health endpoint..."
          if curl -f https://daysave.app/health 2>/dev/null; then
            echo "‚úÖ Health endpoint working"
          else
            echo "‚ùå Health endpoint failed"
          fi
          
          echo "üíæ Test 4: Database connectivity..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            cd daysave_v1.4.1
            if sudo docker-compose -f docker-compose.production.yml --env-file .env.production exec -T db mysql -u daysave -p${{ secrets.DB_USER_PASSWORD }} -e 'USE daysave_v141; SELECT COUNT(*) FROM users;' >/dev/null 2>&1; then
              echo '‚úÖ Database connectivity working'
            else
              echo '‚ùå Database connectivity failed'
            fi
          "
          
          echo "üîê Test 5: Authentication endpoints..."
          if curl -f https://daysave.app/auth/login 2>/dev/null >/dev/null; then
            echo "‚úÖ Auth endpoints accessible"
          else
            echo "‚ùå Auth endpoints failed"
          fi

      # STEP 13: POST-DEPLOYMENT TASKS
      - name: üìã Post-deployment summary
        run: |
          echo "üìã Deployment Summary"
          echo "===================="
          echo "üåê Application URL: https://daysave.app"
          echo "üè• Health Check: https://daysave.app/health"
          echo "üîê Login Page: https://daysave.app/auth/login"
          echo "üìä Admin Panel: https://daysave.app/admin"
          echo ""
          echo "üîß VM Details:"
          echo "- Instance: $INSTANCE_NAME"
          echo "- Zone: $ZONE"
          echo "- Static IP: $STATIC_IP"
          echo "- Instance Type: ${{ github.event.inputs.instance_type }}"
          echo ""
          echo "‚úÖ Deployment completed successfully!"

      - name: üßπ Cleanup on failure
        if: failure()
        run: |
          echo "üßπ Cleaning up failed deployment..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --project=$PROJECT_ID --command="
            cd daysave_v1.4.1 2>/dev/null || true
            sudo docker-compose -f docker-compose.production.yml --env-file .env.production logs --tail=50 || true
            sudo docker ps -a || true
          " || true
