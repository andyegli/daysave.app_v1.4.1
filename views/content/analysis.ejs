<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - DaySave</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .analysis-card {
      transition: box-shadow 0.2s;
      border-radius: 1rem;
      overflow: hidden;
      background: #fff;
      margin-bottom: 1.5rem;
    }
    .analysis-card:hover {
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    }
    .analysis-card .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      line-height: 1.3;
      word-break: break-word;
    }
    .analysis-card .card-text {
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .analysis-badge {
      font-size: 0.85rem;
      margin-right: 0.3rem;
      margin-bottom: 0.3rem;
    }
    .metadata-row {
      padding: 0.5rem 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .metadata-row:last-child {
      border-bottom: none;
    }
    .transcription-text {
      max-height: 400px;
      overflow-y: auto;
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 0.5rem;
      line-height: 1.6;
    }
    .summary-text {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 0.5rem;
      line-height: 1.6;
    }
    .section-header {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
      padding: 1rem;
      border-radius: 0.5rem 0.5rem 0 0;
      margin: 0;
      font-weight: 600;
    }
    .data-section {
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .json-data {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 0.5rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .thumbnail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .thumbnail-item {
      text-align: center;
    }
    .thumbnail-item img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 0.5rem;
      border: 1px solid #dee2e6;
    }
    .back-button {
      margin-bottom: 1.5rem;
    }
  </style>
</head>

<body>
  <!-- Header Include -->
  <%- include('../partials/header', { user, title: title }) %>

  <div class="container mt-5">
    <!-- Back Button -->
    <div class="back-button">
      <a href="/content" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to Content
      </a>
      <% if (analysisData.url) { %>
        <a href="<%= analysisData.url %>" target="_blank" class="btn btn-outline-primary ms-2">
          <i class="bi bi-link-45deg me-2"></i>View Original
        </a>
      <% } %>
    </div>

    <% if (analysisData.hasAnalysis) { %>
      <!-- 1. TITLE SECTION -->
      <div class="analysis-card card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">
            <i class="bi bi-stars me-2"></i>AI-Generated Title
          </h5>
        </div>
        <div class="card-body">
          <h2 class="display-6 mb-0"><%= analysisData.title %></h2>
          <% if (analysisData.generatedTitle && analysisData.generatedTitle !== analysisData.title) { %>
            <small class="text-muted">Alternative: <%= analysisData.generatedTitle %></small>
          <% } %>
        </div>
      </div>

      <!-- 2. SUMMARY SECTION -->
      <% if (analysisData.summary && analysisData.summary.trim()) { %>
        <div class="analysis-card card shadow-sm">
          <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-file-text me-2"></i>Summary
            </h5>
          </div>
          <div class="card-body">
            <div class="summary-text">
              <%= analysisData.summary %>
            </div>
          </div>
        </div>
      <% } %>

      <!-- 3. TRANSCRIPTION SECTION -->
      <% if (analysisData.transcription && analysisData.transcription.trim()) { %>
        <div class="analysis-card card shadow-sm">
          <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-mic me-2"></i>Transcription
            </h5>
          </div>
          <div class="card-body">
            <div class="transcription-text">
              <%= analysisData.transcription %>
            </div>
            <small class="text-muted mt-2 d-block">
              Word count: <%= analysisData.transcription.split(' ').length %>
            </small>
          </div>
        </div>
      <% } %>

      <!-- 4. TAGS AND CATEGORIZATION -->
      <div class="analysis-card card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h5 class="card-title mb-0">
            <i class="bi bi-tags me-2"></i>Tags & Classification
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <% if (analysisData.autoTags && analysisData.autoTags.length > 0) { %>
                <h6 class="fw-bold mb-2">
                  <i class="bi bi-robot me-1 text-primary"></i>AI-Generated Tags
                </h6>
                <div class="mb-3">
                  <% analysisData.autoTags.forEach(tag => { %>
                    <span class="badge bg-primary analysis-badge"><%= tag %></span>
                  <% }); %>
                </div>
              <% } %>
              
              <% if (analysisData.userTags && analysisData.userTags.length > 0) { %>
                <h6 class="fw-bold mb-2">
                  <i class="bi bi-person me-1 text-success"></i>User Tags
                </h6>
                <div class="mb-3">
                  <% analysisData.userTags.forEach(tag => { %>
                    <span class="badge bg-success analysis-badge"><%= tag %></span>
                  <% }); %>
                </div>
              <% } %>
            </div>
            
            <div class="col-md-6">
              <% if (analysisData.category) { %>
                <h6 class="fw-bold mb-2">
                  <i class="bi bi-folder me-1 text-info"></i>Category
                </h6>
                <span class="badge bg-info text-white fs-6 mb-3"><%= analysisData.category %></span>
              <% } %>
              
              <% if (analysisData.sentiment) { %>
                <h6 class="fw-bold mb-2">
                  <i class="bi bi-emoji-smile me-1 text-secondary"></i>Sentiment
                </h6>
                <% 
                  let sentimentClass = 'secondary';
                  let sentimentIcon = 'emoji-neutral';
                  if (analysisData.sentiment.label) {
                    if (analysisData.sentiment.label.toLowerCase() === 'positive') {
                      sentimentClass = 'success';
                      sentimentIcon = 'emoji-smile';
                    } else if (analysisData.sentiment.label.toLowerCase() === 'negative') {
                      sentimentClass = 'danger';
                      sentimentIcon = 'emoji-frown';
                    }
                  }
                %>
                <span class="badge bg-<%= sentimentClass %> fs-6">
                  <i class="bi bi-<%= sentimentIcon %> me-1"></i>
                  <%= analysisData.sentiment.label || 'Unknown' %>
                  <% if (analysisData.sentiment.confidence) { %>
                    (<%= Math.round(analysisData.sentiment.confidence * 100) %>%)
                  <% } %>
                </span>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- 5. USER COMMENTS -->
      <% if (analysisData.userComments && analysisData.userComments.trim()) { %>
        <div class="analysis-card card shadow-sm">
          <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-chat-text me-2"></i>User Comments
            </h5>
          </div>
          <div class="card-body">
            <div class="summary-text">
              <%= analysisData.userComments %>
            </div>
          </div>
        </div>
      <% } %>

      <!-- 6. THUMBNAILS -->
      <% if (analysisData.thumbnails && analysisData.thumbnails.length > 0) { %>
        <div class="analysis-card card shadow-sm">
          <div class="card-header bg-dark text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-images me-2"></i>Thumbnails (<%= analysisData.thumbnails.length %>)
            </h5>
          </div>
          <div class="card-body">
            <div class="thumbnail-grid">
              <% analysisData.thumbnails.forEach((thumb, index) => { %>
                <div class="thumbnail-item">
                                      <img src="<%= (thumb.url || thumb.file_path).startsWith('/') ? (thumb.url || thumb.file_path) : '/' + (thumb.url || thumb.file_path) %>" alt="Thumbnail <%= index + 1 %>">
                  <% if (thumb.timestamp !== undefined) { %>
                    <small class="text-muted d-block mt-1">
                      <%= Math.floor(thumb.timestamp / 60) %>:<%= String(Math.floor(thumb.timestamp % 60)).padStart(2, '0') %>
                    </small>
                  <% } %>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      <% } %>

      <!-- 7. SPEAKERS -->
      <% if (analysisData.speakers && analysisData.speakers.length > 0) { %>
        <div class="analysis-card card shadow-sm">
          <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-person-voice me-2"></i>Speakers (<%= analysisData.speakers.length %>)
            </h5>
          </div>
          <div class="card-body">
            <% analysisData.speakers.forEach((speaker, index) => { %>
              <div class="metadata-row">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong><%= speaker.name || `Speaker ${index + 1}` %></strong>
                    <% if (speaker.gender) { %>
                      <span class="badge bg-light text-dark ms-2"><%= speaker.gender %></span>
                    <% } %>
                  </div>
                  <div class="text-end">
                    <% if (speaker.confidence) { %>
                      <small class="text-muted">Confidence: <%= Math.round(speaker.confidence * 100) %>%</small>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        </div>
      <% } %>

      <!-- 8. OCR CAPTIONS -->
      <% if (analysisData.ocrCaptions && analysisData.ocrCaptions.length > 0) { %>
        <div class="analysis-card card shadow-sm">
          <div class="card-header bg-warning text-dark">
            <h5 class="card-title mb-0">
              <i class="bi bi-search me-2"></i>Extracted Text (OCR) - <%= analysisData.ocrCaptions.length %> segments
            </h5>
          </div>
          <div class="card-body">
            <div style="max-height: 300px; overflow-y: auto;">
              <% analysisData.ocrCaptions.forEach((ocr, index) => { %>
                <div class="metadata-row">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <span><%= ocr.text %></span>
                    </div>
                    <div class="text-end ms-3">
                      <% if (ocr.timestamp !== undefined) { %>
                        <small class="text-muted d-block">
                          <%= Math.floor(ocr.timestamp / 60) %>:<%= String(Math.floor(ocr.timestamp % 60)).padStart(2, '0') %>
                        </small>
                      <% } %>
                      <% if (ocr.confidence) { %>
                        <small class="text-muted d-block">
                          <%= Math.round(ocr.confidence * 100) %>%
                        </small>
                      <% } %>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      <% } %>

      <!-- 9. TECHNICAL METADATA -->
      <% if (analysisData.metadata && Object.keys(analysisData.metadata).length > 0) { %>
        <div class="analysis-card card shadow-sm">
          <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-gear me-2"></i>Technical Metadata
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <% 
                const importantFields = ['mimetype', 'duration', 'size', 'width', 'height', 'title', 'description'];
                const displayedFields = [];
                importantFields.forEach(field => {
                  if (analysisData.metadata[field] !== undefined && analysisData.metadata[field] !== null) {
                    displayedFields.push({key: field, value: analysisData.metadata[field]});
                  }
                });
                
                // Add other fields
                Object.keys(analysisData.metadata).forEach(key => {
                  if (!importantFields.includes(key) && analysisData.metadata[key] !== undefined && analysisData.metadata[key] !== null) {
                    displayedFields.push({key: key, value: analysisData.metadata[key]});
                  }
                });
              %>
              
              <% displayedFields.forEach((field, index) => { %>
                <% if (index % 2 === 0) { %><div class="col-md-6"><% } %>
                  <div class="metadata-row">
                    <strong><%= field.key.replace(/_/g, ' ').toUpperCase() %>:</strong>
                    <span class="ms-2">
                      <% if (typeof field.value === 'object') { %>
                        <pre class="json-data small mb-0"><%= JSON.stringify(field.value, null, 2) %></pre>
                      <% } else { %>
                        <%= field.value %>
                      <% } %>
                    </span>
                  </div>
                <% if (index % 2 === 1 || index === displayedFields.length - 1) { %></div><% } %>
              <% }); %>
            </div>
          </div>
        </div>
      <% } %>

      <!-- 10. DETAILED ANALYSIS DATA -->
      <% if (analysisData.analysis) { %>
        <div class="analysis-card card shadow-sm">
          <div class="card-header bg-dark text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-cpu me-2"></i>Raw Analysis Data
            </h5>
          </div>
          <div class="card-body">
            <% if (analysisData.videoAnalysis) { %>
              <h6 class="fw-bold mb-3">Video Analysis</h6>
              <div class="json-data">
                <%= JSON.stringify(analysisData.videoAnalysis, null, 2) %>
              </div>
            <% } %>
            
            <% if (analysisData.audioAnalysis) { %>
              <h6 class="fw-bold mb-3 mt-4">Audio Analysis</h6>
              <div class="json-data">
                <%= JSON.stringify(analysisData.audioAnalysis, null, 2) %>
              </div>
            <% } %>
            
            <% if (analysisData.imageAnalysis) { %>
              <h6 class="fw-bold mb-3 mt-4">Image Analysis</h6>
              <div class="json-data">
                <%= JSON.stringify(analysisData.imageAnalysis, null, 2) %>
              </div>
            <% } %>
          </div>
        </div>
      <% } %>

      <!-- 11. PROCESSING INFORMATION -->
      <% if (analysisData.processingJobs && analysisData.processingJobs.length > 0) { %>
        <div class="analysis-card card shadow-sm">
          <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-clock-history me-2"></i>Processing History
            </h5>
          </div>
          <div class="card-body">
            <% analysisData.processingJobs.forEach((job, index) => { %>
              <div class="metadata-row">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>Job #<%= index + 1 %></strong>
                    <span class="badge bg-<%= job.status === 'completed' ? 'success' : job.status === 'failed' ? 'danger' : 'warning' %> ms-2">
                      <%= job.status %>
                    </span>
                  </div>
                  <div class="text-end">
                    <small class="text-muted">
                      <% if (job.createdAt) { %>
                        <%= new Date(job.createdAt).toLocaleString() %>
                      <% } %>
                    </small>
                  </div>
                </div>
                <% if (job.current_stage) { %>
                  <small class="text-muted d-block mt-1">Stage: <%= job.current_stage %></small>
                <% } %>
                <% if (job.progress) { %>
                  <div class="progress mt-2" style="height: 5px;">
                    <div class="progress-bar" role="progressbar" style="width: <%= job.progress %>%"></div>
                  </div>
                <% } %>
              </div>
            <% }); %>
          </div>
        </div>
      <% } %>

    <% } else { %>
      <!-- NO ANALYSIS AVAILABLE -->
      <div class="analysis-card card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h5 class="card-title mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>No Analysis Available
          </h5>
        </div>
        <div class="card-body text-center">
          <div class="py-5">
            <i class="bi bi-robot text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3">Analysis Not Yet Complete</h4>
            <p class="text-muted">This content has not been processed by our AI analysis system yet.</p>
            <% if (analysisData.latestJob && analysisData.latestJob.status === 'processing') { %>
              <div class="mt-4">
                <div class="spinner-border text-primary me-2" role="status">
                  <span class="visually-hidden">Processing...</span>
                </div>
                <span>Analysis in progress... <%= analysisData.latestJob.progress || 0 %>% complete</span>
              </div>
            <% } else { %>
              <button class="btn btn-primary mt-3" onclick="triggerAnalysis()">
                <i class="bi bi-play-fill me-2"></i>Start Analysis
              </button>
            <% } %>
          </div>
        </div>
      </div>
    <% } %>

    <!-- CONTENT/FILE DETAILS -->
    <div class="analysis-card card shadow-sm">
      <div class="card-header bg-light text-dark">
        <h5 class="card-title mb-0">
          <i class="bi bi-info-circle me-2"></i>Content Details
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="metadata-row">
              <strong>URL:</strong>
              <span class="ms-2">
                <% if (analysisData.url) { %>
                  <a href="<%= analysisData.url %>" target="_blank" class="text-break">
                    <%= analysisData.url %>
                  </a>
                <% } else { %>
                  Local File
                <% } %>
              </span>
            </div>
            <div class="metadata-row">
              <strong>Media Type:</strong>
              <span class="ms-2 text-capitalize"><%= analysisData.mediaType %></span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="metadata-row">
              <strong>Created:</strong>
              <span class="ms-2"><%= new Date(analysisData.createdAt).toLocaleString() %></span>
            </div>
            <div class="metadata-row">
              <strong>Last Updated:</strong>
              <span class="ms-2"><%= new Date(analysisData.updatedAt).toLocaleString() %></span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Footer Include -->
  <%- include('../partials/footer') %>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Analysis Page JS -->
  <script src="/js/analysis-page.js"></script>
</body>
</html> 