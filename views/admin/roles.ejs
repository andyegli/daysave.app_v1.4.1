<%- include('../partials/header', { title: title, user: user }) %>

<style>
  .role-card {
    transition: all 0.3s ease;
    border-left: 4px solid #007bff;
  }
  
  .role-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .permission-matrix {
    font-size: 0.85rem;
  }
  
  .permission-category {
    background: linear-gradient(45deg, #f8f9fa, #e9ecef);
    border-left: 3px solid #007bff;
  }
  
  .permission-item {
    transition: background-color 0.2s ease;
  }
  
  .permission-item:hover {
    background-color: #f8f9fa;
  }
  
  .role-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
  
  .user-count-badge {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    border: none;
  }
  
  .matrix-cell {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .matrix-cell.has-permission {
    background-color: #d4edda;
    color: #155724;
  }
  
  .matrix-cell.no-permission {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  .matrix-cell:hover {
    transform: scale(1.1);
    z-index: 10;
    position: relative;
  }
  
  .sticky-header {
    position: sticky;
    top: 0;
    background: white;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
</style>

<div class="container-fluid mt-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="fas fa-user-shield text-primary me-2"></i>Role & Permission Management</h2>
      <p class="text-muted">Manage user roles and their associated permissions</p>
    </div>
    <div>
      <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#createRoleModal">
        <i class="fas fa-plus me-1"></i>Create Role
      </button>
      <a href="/admin/dashboard" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
      </a>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4" id="rolesTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
        <i class="fas fa-chart-pie me-1"></i>Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="matrix-tab" data-bs-toggle="tab" data-bs-target="#matrix" type="button" role="tab">
        <i class="fas fa-table me-1"></i>Permission Matrix
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="permissions-tab" data-bs-toggle="tab" data-bs-target="#permissions" type="button" role="tab">
        <i class="fas fa-key me-1"></i>All Permissions
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="rolesTabContent">
    
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
      <div class="row">
        <% roles.forEach(role => { %>
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card role-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <span class="role-badge badge bg-primary"><%= role.name %></span>
              </h5>
              <span class="user-count-badge badge">
                <%= userCountMap[role.name] || 0 %> users
              </span>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-3"><%= role.description || 'No description available' %></p>
              
              <div class="mb-3">
                <strong>Permissions (<%= role.Permissions ? role.Permissions.length : 0 %>):</strong>
                <div class="mt-2">
                  <% if (role.Permissions && role.Permissions.length > 0) { %>
                    <% role.Permissions.slice(0, 6).forEach(permission => { %>
                      <span class="badge bg-light text-dark me-1 mb-1" title="<%= permission.description %>">
                        <%= permission.name %>
                      </span>
                    <% }); %>
                    <% if (role.Permissions.length > 6) { %>
                      <span class="badge bg-secondary">+<%= role.Permissions.length - 6 %> more</span>
                    <% } %>
                  <% } else { %>
                    <span class="text-muted small">No permissions assigned</span>
                  <% } %>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <div class="btn-group w-100" role="group">
                <button class="btn btn-outline-primary btn-sm" onclick="viewRoleDetails('<%= role.id %>')">
                  <i class="fas fa-eye me-1"></i>View
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="editRolePermissions('<%= role.id %>')">
                  <i class="fas fa-edit me-1"></i>Edit
                </button>
                <% if (!['admin', 'user'].includes(role.name)) { %>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteRole('<%= role.id %>', '<%= role.name %>')">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
                <% } %>
              </div>
            </div>
          </div>
        </div>
        <% }); %>
      </div>
    </div>

    <!-- Permission Matrix Tab -->
    <div class="tab-pane fade" id="matrix" role="tabpanel">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-table me-2"></i>Role-Permission Matrix</h5>
          <small class="text-muted">Click on cells to toggle permissions (✓ = has permission, ✗ = no permission)</small>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <div id="permissionMatrix">
              <div class="text-center p-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading matrix...</span>
                </div>
                <p class="mt-2 text-muted">Loading permission matrix...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- All Permissions Tab -->
    <div class="tab-pane fade" id="permissions" role="tabpanel">
      <div class="row">
        <% Object.keys(permissionsByCategory).forEach(category => { %>
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card">
            <div class="card-header permission-category">
              <h6 class="mb-0 text-uppercase">
                <i class="fas fa-folder me-2"></i><%= category %>
                <span class="badge bg-primary ms-2"><%= permissionsByCategory[category].length %></span>
              </h6>
            </div>
            <div class="card-body p-0">
              <% permissionsByCategory[category].forEach(permission => { %>
              <div class="permission-item p-3 border-bottom">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong class="text-primary"><%= permission.name %></strong>
                    <p class="text-muted small mb-0"><%= permission.description || 'No description' %></p>
                  </div>
                  <span class="badge bg-light text-dark"><%= permission.id %></span>
                </div>
              </div>
              <% }); %>
            </div>
          </div>
        </div>
        <% }); %>
      </div>
    </div>
  </div>
</div>

<!-- Create Role Modal -->
<div class="modal fade" id="createRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Create New Role</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="createRoleForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="roleName" class="form-label">Role Name</label>
            <input type="text" class="form-control" id="roleName" name="name" required 
                   pattern="[a-z_]+" title="Lowercase letters and underscores only">
            <div class="form-text">Use lowercase letters and underscores only (e.g., custom_role)</div>
          </div>
          <div class="mb-3">
            <label for="roleDescription" class="form-label">Description</label>
            <textarea class="form-control" id="roleDescription" name="description" rows="3" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-plus me-1"></i>Create Role
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Role Details Modal -->
<div class="modal fade" id="roleDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Role Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="roleDetailsContent">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script src="/js/admin-roles.js?v=<%= Date.now() %>"></script>

<%- include('../partials/footer') %>
